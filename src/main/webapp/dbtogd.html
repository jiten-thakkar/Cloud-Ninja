<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Cloud Ninja</title>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/dropbox.js/0.10.2/dropbox.min.js"></script>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/angularjs/1.2.16/angular.min.js"></script>
<script type="text/javascript" src="js/static/treeview.min.js"></script>
<script type="text/javascript" src="js/authenticateDb.js"></script>
<link rel="stylesheet" type="text/css" href="css/treeview.css">
<script type="text/javascript">
$(document).ready(function(){
	$("#unlink_db").hide();	
	/* $.ajax({
	type: "GET",
	url: "js/dbtogd.js",
	dataType: "script"
	}); */
	authenticateDb();
	/* if(client instanceof Dropbox.Client)
		{alert('instance');} */
	//console.log(client.credentials().token);
	//$scope.$apply(fileTree(client, "/"));
});
(function fileTree() {
	//angular module
    var myApp = angular.module('fileViewer', ['oci.treeview']);
    var client = authenticateDb();
    //console.log(client.credentials().token);
    //test controller
    
    myApp.controller('AppCtrl', function ($scope, $timeout) {
    	
    	function parseFileNames(entries, directory) {
    		var files = [];
    		for(var i=0; i<entries.length; i++) {
  				var patt=/.*\..*/;
  				var tempNode = {};
  				tempNode.label = entries[i];
				tempNode.path = directory+'/'+entries[i];
				tempNode.children = [];
  				if(patt.test(entries[i])) {
  					tempNode.state = 'leaf';
  					tempNode.visited = true;
  					//console.log(entries[i]+" true");
  				}
  				else{
  					tempNode.state = 'collapsed';
  					//console.log(entries[i]+" false");
  				}
  				  				
  				files.push(tempNode);
  			  }
    		return files;
    	};
        $scope.fetchFileList = function (client, directory) {                    	
	      	client.readdir(directory, function(error, entries) {
				  if (error) {
				    return alert("Couldn't fetch file list. Refresh the page.");  // Something went wrong.
			}
		    var filelist = {};
		    filelist = {
				  label: 'root',
				  state: 'expanded',
				  path: directory,
				  children: []
		    };
			  //console.log("Your Dropbox contains " + entries.toString());
				  
   			filelist.children = parseFileNames(entries, directory);
   			$scope.treeData = filelist;
   			console.log($scope.treeData);
   			$timeout();
         	//treedata = filelist;
         	//return filelist;
   			  //var myApp = angular.module('myApp', ['angularTreeview']);
   			});
         };
        $scope.fetchFileList(client, "/");
		//$scope.treeData = $scope.filelist;
		//console.log(list);

        // When a node is clicked on (icon or label), it will add a
        // new child node. This happens only once per node due to
        // the complete flag.
        $scope.getMoreData = function (node) {
            return $timeout(function () {
            	if(!node.visited) {
            		client.readdir(node.path, function(error, entries) {
	            		if (error) {
	        			    return alert("Couldn't fetch file list. Refresh the page.");  // Something went wrong.
	        			}
	            		var files = parseFileNames(entries, node.path);
	            		node.children = files;
	            		node.state = 'expanded';
	            		node.visited = true;
	            		$timeout();
            		});
            	} 
            	if(node.state == 'leaf') {
            		$("#selected").text(node.label);
            	}/* else if (node.state == 'collapsed') {
                    node.state = 'expanded';
                } else if (node.state == 'expanded') {
                	node.state = 'collapsed';	
                } */
            });
        };
    });
})();
</script>
</head>
<body>
	<button id="unlink_db">Unlink Dropbox</button>
	<textarea id="selected" rows="1" cols="100" style="position:relative; float:right" readonly></textarea>
	<button id="copy" onClick="" style="position: relative; float:right">Copy</button>
	<b><h3 style=" float:right">Selected File</h3></b>
	<div data-ng-app="fileViewer">
    <div data-ng-controller="AppCtrl">
        <oci.treeview tree="treeData" on-select-node="getMoreData">
        <span ng-click="selectNode(tree)">{{tree.label}}</span></oci.treeview>
        
    </div>
</div>
</body>
</html>